<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Filtro Vini · Decanter Wine & More</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="Filtra i vini per tono e regione - Decanter Wine & More">
    
    <!-- Meta tag iOS (PWA/Home Screen) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Decanter">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8B4513">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="logo.ico">
    
    
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts con font-display: swap per evitare FOUC -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome - Preconnect per velocizzare il caricamento -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <!-- Font Awesome - Caricamento con timestamp per evitare cache - con fallback locale -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css?v=2" crossorigin="anonymous" id="fontAwesomeCSS"
          onerror="this.onerror=null; this.href='fonts/font-awesome/css/all.min.css';">
    
    <style>
        /* Stili per i filtri */
        .filters-wrapper {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 1rem;
            border: 1px solid rgba(255, 201, 40, 0.55);
            padding: 0.4rem 0.85rem;
            box-shadow: 0 16px 30px rgba(0, 0, 0, 0.75);
            margin-bottom: 1rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transition: padding 0.25s ease, margin-bottom 0.25s ease;
        }

        .filters-wrapper:not(.collapsed) {
            padding: 0.4rem 0.85rem 0.45rem;
        }

        .filters-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            user-select: none;
            padding: 0.2rem 0;
        }

        .filters-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: #D4AF37;
            text-align: center;
        }

        /* Handle con due trattini - posizionato in fondo */
        .filters-handle {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.12rem;
            padding-top: 0.3rem;
            padding-bottom: 0.15rem;
            margin-top: auto;
        }

        .filters-handle-line {
            width: 22px;
            height: 2px;
            border-radius: 999px;
            background-color: rgba(255, 201, 40, 0.85);
        }

        /* Contenitore interno con Tono e Regione affiancati */
        .filters-container {
            display: flex;
            flex-direction: row;
            gap: 0.6rem;
            width: 100%;
            box-sizing: border-box;
            margin-top: 0.4rem;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            position: relative;
        }

        .filters-wrapper.collapsed .filters-container {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-top: 0;
        }

        .filters-wrapper:not(.collapsed) .filters-container {
            max-height: 400px;
            opacity: 1;
        }
        
        .filter-section {
            background: transparent;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 201, 40, 0.4);
            padding: 0.6rem 0.6rem 0.8rem;
            box-shadow: none;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex: 1 1 0;
        }
        
        .filter-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: #D4AF37;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            padding: 0.3rem 0;
            transition: color 0.2s ease;
        }
        
        .filter-section-title-icon {
            display: none;
        }
        
        .category-filter {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease, margin-top 0.3s ease, opacity 0.3s ease;
            margin-top: 0;
            opacity: 0;
        }
        
        .filters-wrapper:not(.collapsed) .category-filter {
            /* Altezza fissa per mostrare esattamente 4 tab:
               Ogni bottone ~2.4rem, 4 bottoni = 9.6rem, 3 gap da 0.4rem = 1.2rem, totale ~10.8rem */
            height: 10.8rem;
            margin-top: 0.6rem;
            opacity: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Stile scrollbar personalizzato per category-filter */
        .category-filter::-webkit-scrollbar {
            width: 6px;
        }
        
        .category-filter::-webkit-scrollbar-track {
            background: rgba(17, 17, 17, 0.5);
            border-radius: 3px;
        }
        
        .category-filter::-webkit-scrollbar-thumb {
            background: rgba(255, 201, 40, 0.5);
            border-radius: 3px;
        }
        
        .category-filter::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 201, 40, 0.7);
        }
        
        .filter-btn {
            padding: 0.6rem 1.2rem;
            background: transparent;
            border: 2px solid rgba(255, 201, 40, 0.5);
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
        }
        
        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FFC928, #D4AF37);
            transition: left 0.3s ease;
            z-index: -1;
        }
        
        .filter-btn:hover::before,
        .filter-btn.active::before {
            left: 0;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            border-color: #8B4513;
            color: #111111;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        
        .wine-grid {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }
        
        .wine-item {
            padding: 0.65rem 0.55rem;
            border-radius: 0.7rem;
            background: rgba(17, 17, 17, 0.96);
            border: 1px solid rgba(255, 201, 40, 0.22);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .wine-item.hidden {
            display: none;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }
        
        .wine-item.showing {
            animation: fadeInScale 0.5s ease forwards;
        }
        
        .wine-item.hiding {
            animation: fadeOut 0.3s ease forwards;
        }
        
        /* Pill colorate per categorie */
        .wine-item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.4rem;
        }
        
        /* Pulsante preferiti */
        .wine-item {
            position: relative;
        }
        
        .favorite-btn {
            position: absolute;
            top: 50%;
            right: 0.55rem;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.3rem;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .favorite-btn:hover {
            color: #FFC928;
            transform: translateY(-50%) scale(1.1);
        }
        
        .favorite-btn.active {
            color: #FFC928;
        }
        
        .favorite-btn.active:hover {
            color: #D4AF37;
        }
        
        /* Pulsante dettagli (INFO) */
        .details-btn {
            position: relative;
            display: inline-block;
            background: #FFC928;
            border: none;
            border-radius: 0.3rem;
            padding: 0.4rem 0.8rem;
            color: #000000;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .details-btn:hover {
            background: #D4AF37;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 201, 40, 0.4);
        }
        
        /* Banner dettagli */
        .wine-details-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(17, 17, 17, 0.98);
            border-top: 3px solid #FFC928;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s ease;
            z-index: 1000;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);
        }
        
        .wine-details-banner.open {
            transform: translateY(0);
        }
        
        .wine-details-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 201, 40, 0.3);
        }
        
        .wine-details-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #FFC928;
            margin: 0;
        }
        
        .wine-details-close {
            background: transparent;
            border: 2px solid rgba(255, 201, 40, 0.5);
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFC928;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .wine-details-close:hover {
            background: rgba(255, 201, 40, 0.2);
            border-color: #FFC928;
            transform: rotate(90deg);
        }
        
        .wine-details-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .wine-details-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .wine-details-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 201, 40, 0.7);
            font-weight: 600;
        }
        
        .wine-details-value {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }
        
        .wine-details-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #FFC928;
            margin-top: 0.5rem;
        }
        
        .wine-details-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 999;
        }
        
        .wine-details-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .wine-tag {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #111111;
        }
        
        /* Colori per tono */
        .wine-tag--tono-bianco {
            background-color: #F5E6D3;
        }
        
        .wine-tag--tono-rosso {
            background-color: #7b1020;
            color: #ffffff;
        }
        
        .wine-tag--tono-rosè {
            background-color: #E8B4B8;
        }
        
        .wine-tag--tono-prosecco {
            background-color: #D4E8D4;
        }
        
        .wine-tag--tono-champagne {
            background-color: #FFE5B4;
        }
        
        /* Colori per regione */
        .wine-tag--regione-toscana {
            background-color: #8B4513;
            color: #ffffff;
        }
        
        .wine-tag--regione-piemonte {
            background-color: #A0522D;
            color: #ffffff;
        }
        
        .wine-tag--regione-veneto {
            background-color: #722F37;
            color: #ffffff;
        }
        
        .wine-tag--regione-campania {
            background-color: #D4AF37;
        }
        
        .wine-tag--regione-sicilia {
            background-color: #CD853F;
            color: #ffffff;
        }
        
        /* Stili per la barra di ricerca */
        .search-section {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 1rem;
            border: 1px solid rgba(255, 201, 40, 0.55);
            padding: 0.9rem 0.95rem 1rem;
            box-shadow: 0 16px 30px rgba(0, 0, 0, 0.75);
            margin-bottom: 1.2rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 2px solid rgba(255, 201, 40, 0.5);
            border-radius: 30px;
            font-size: 0.9rem;
            font-family: 'Montserrat', sans-serif;
            background: rgba(17, 17, 17, 0.96);
            color: #ffffff;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Sezione ricerche senza risultati */
        .no-results-section {
            margin-top: 2rem;
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid rgba(255, 201, 40, 0.3);
            border-radius: 0.7rem;
            padding: 1rem;
        }
        
        .no-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .no-results-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 201, 40, 0.8);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .no-results-toggle {
            background: transparent;
            border: 1px solid rgba(255, 201, 40, 0.3);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 201, 40, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .no-results-toggle:hover {
            background: rgba(255, 201, 40, 0.1);
            border-color: rgba(255, 201, 40, 0.5);
        }
        
        .no-results-toggle.expanded i {
            transform: rotate(180deg);
        }
        
        .no-results-content {
            margin-top: 0.5rem;
        }
        
        .no-results-info {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }
        
        .no-results-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .no-results-list li {
            padding: 0.5rem;
            background: rgba(17, 17, 17, 0.5);
            border-radius: 0.4rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            border-left: 3px solid rgba(255, 201, 40, 0.5);
        }
        
        .no-results-list li:empty {
            display: none;
        }
        
        /* Media query per schermi piccoli - riduce dimensioni schede */
        @media (max-width: 480px) {
            .filters-container {
                gap: 0.4rem;
            }
            
            .filter-section {
                padding: 0.4rem 0.4rem 0.5rem;
            }
            
            .filter-section-title {
                font-size: 0.7rem;
                padding: 0.2rem 0;
            }
            
            .filter-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .category-filter {
                gap: 0.4rem;
            }
        }
    </style>
</head>
<body class="menu-body">
    <!-- Sfondo SVG animato del vino -->
    <div class="wine-background">
        <svg viewBox="0 0 220 300" role="img" aria-label="Vino rosso 2D con cima ondulata (trasparente)" class="wine-svg">
            <defs>
                <linearGradient id="wineGrad-filtro" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0" stop-color="#7b1020"/>
                    <stop offset=".55" stop-color="#4c0612"/>
                    <stop offset="1" stop-color="#2a0208"/>
                </linearGradient>
                <clipPath id="wineWaveClip-filtro">
                    <path>
                        <animate attributeName="d" dur="2.6s" repeatCount="indefinite"
                            values="
                            M64 246 L64 90
                            C82 84, 100 96, 110 90
                            C120 84, 138 96, 156 90
                            L156 246 Z;
                            M64 246 L64 90
                            C82 96, 100 84, 110 90
                            C120 96, 138 84, 156 90
                            L156 246 Z;
                            M64 246 L64 90
                            C82 84, 100 96, 110 90
                            C120 84, 138 96, 156 90
                            L156 246 Z
                            " />
                    </path>
                </clipPath>
            </defs>
            <g clip-path="url(#wineWaveClip-filtro)">
                <rect x="64" y="84" width="92" height="162" fill="url(#wineGrad-filtro)"/>
                <path d="M78 98 C88 128, 80 190, 96 236"
                    fill="none" stroke="rgba(255,255,255,.18)" stroke-width="8" stroke-linecap="round"/>
                <path d="M148 96 C138 140, 146 196, 140 236"
                    fill="none" stroke="rgba(0,0,0,.22)" stroke-width="10" stroke-linecap="round"/>
            </g>
        </svg>
    </div>
    <div class="menu-page">
        <header class="menu-header">
            <div class="menu-header-left">
                <div class="menu-logo">
                    <img src="logo.png" alt="Decanter Wine & More">
                </div>
                <div class="menu-title-block">
                    <span class="menu-eyebrow">Decanter Wine &amp; More</span>
                    <h1 class="menu-title">Filtro Vini</h1>
                </div>
            </div>
            <a href="home.html" class="menu-close">
                <span>&larr;</span>
                <span>Home</span>
            </a>
        </header>

        <p class="menu-intro">
            Seleziona le categorie per filtrare i vini disponibili. Puoi selezionare più opzioni per ogni sezione.
        </p>

        <!-- Barra di ricerca -->
        <div class="search-section">
            <input type="text" 
                   class="search-input" 
                   placeholder="Cerca vini per nome o descrizione..." 
                   id="menuSearchInput">
        </div>

        <!-- Box Filtri con Tono e Regione affiancati -->
        <section class="filters-wrapper collapsed" aria-label="Filtri">
            <div class="filters-header">
                <span class="filters-title">Filtri</span>
            </div>
            <div class="filters-container">
                <!-- Filtro Tono -->
                <div class="filter-section" id="filter-tono">
                    <h2 class="filter-section-title">Tono</h2>
                    <div class="category-filter">
                        <button class="filter-btn active" data-filter-type="tono" data-category="all">Tutto</button>
                        <button class="filter-btn" data-filter-type="tono" data-category="bianco">Bianco</button>
                        <button class="filter-btn" data-filter-type="tono" data-category="rosso">Rosso</button>
                        <button class="filter-btn" data-filter-type="tono" data-category="rosè">Rosè</button>
                        <button class="filter-btn" data-filter-type="tono" data-category="prosecco">Prosecco</button>
                        <button class="filter-btn" data-filter-type="tono" data-category="champagne">Champagne</button>
                    </div>
                </div>

                <!-- Filtro Regione -->
                <div class="filter-section" id="filter-regione">
                    <h2 class="filter-section-title">Regione</h2>
                    <div class="category-filter">
                        <button class="filter-btn active" data-filter-type="regione" data-category="all">Tutto</button>
                        <button class="filter-btn" data-filter-type="regione" data-category="toscana">Toscana</button>
                        <button class="filter-btn" data-filter-type="regione" data-category="piemonte">Piemonte</button>
                        <button class="filter-btn" data-filter-type="regione" data-category="veneto">Veneto</button>
                        <button class="filter-btn" data-filter-type="regione" data-category="campania">Campania</button>
                        <button class="filter-btn" data-filter-type="regione" data-category="sicilia">Sicilia</button>
                    </div>
                </div>
            </div>
            <div class="filters-handle">
                <span class="filters-handle-line"></span>
                <span class="filters-handle-line"></span>
            </div>
        </section>

        <!-- Lista Vini -->
        <section class="menu-section">
            <h2 class="menu-section-title">Vini Disponibili</h2>
            <div class="wine-grid" id="wineGrid">
                <!-- I vini verranno caricati dinamicamente -->
            </div>
            
            <!-- Sezione ricerche senza risultati (nascosta di default) -->
            <div id="noResultsSection" class="no-results-section" style="display: none;">
                <div class="no-results-header">
                    <h3 class="no-results-title">Ricerche senza risultati</h3>
                    <button class="no-results-toggle" id="noResultsToggle" aria-label="Mostra/Nascondi ricerche senza risultati">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="no-results-content" id="noResultsContent" style="display: none;">
                    <p class="no-results-info">Queste sono le ricerche effettuate che non hanno dato risultati:</p>
                    <ul class="no-results-list" id="noResultsList">
                        <!-- Le ricerche senza risultati verranno aggiunte qui -->
                    </ul>
                </div>
            </div>
        </section>

        <p class="menu-footer">
            La carta dei vini può variare in base alla disponibilità e alle proposte stagionali.
        </p>
        <p class="menu-footer menu-footer-designed">
            Designed by <a href="autore.html" class="footer-author-link">MeStesso</a>
        </p>
        <p class="menu-footer menu-footer-designed" style="margin-top: 0.3rem;">
            <a href="policy.html" class="footer-author-link">Policy</a>
        </p>
    </div>

    <!-- Barra fissa in basso -->
    <div class="bottom-bar">
        <a href="https://wa.me/393713674624" class="bottom-bar-btn bottom-bar-btn--wa" target="_blank" rel="noopener">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
        </a>
        <a href="https://www.instagram.com/decanterwineand/" class="bottom-bar-btn bottom-bar-btn--ig" target="_blank" rel="noopener">
            <i class="fab fa-instagram"></i>
            <span>Instagram</span>
        </a>
        <a href="tel:+393713674624" class="bottom-bar-btn bottom-bar-btn--call">
            <i class="fas fa-phone"></i>
            <span>Chiama</span>
        </a>
    </div>

    <!-- Banner Cookie Consenso -->
    <div id="cookie-banner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.95); color: #ffffff; padding: 1.5rem; z-index: 10000; border-top: 2px solid #FFC928; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);">
    <script>
        // Controllo immediato del consenso PRIMA che il DOM sia completamente caricato
        // Questo assicura che il banner venga mostrato/nascosto correttamente
        (function() {
            const CONSENT_KEY = window.CONSENT_KEY || 'cookie_consent_idedecanter';
            
            // Funzione per gestire il banner - legge il consenso ogni volta
            function handleBanner() {
                const banner = document.getElementById('cookie-banner');
                if (!banner) {
                    // Se il banner non esiste ancora, riprova dopo un breve delay
                    setTimeout(handleBanner, 50);
                    return;
                }
                
                // Leggi il consenso ogni volta (non solo all'inizio)
                const consent = localStorage.getItem(CONSENT_KEY);
                
                // Se il consenso è già stato dato, nascondi il banner
                if (consent === 'granted') {
                    banner.style.display = 'none';
                } else {
                    // Se il consenso è negato o non esiste (null), mostra il banner
                    // Questo assicura che il banner venga riproposto ad ogni visita
                    banner.style.display = 'block';
                }
            }
            
            // Esegui quando il DOM è disponibile
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', handleBanner);
            } else {
                // Se il DOM è già pronto, esegui immediatamente
                handleBanner();
            }
            
            // Riprova anche dopo un breve delay per assicurarsi che il banner sia gestito
            setTimeout(handleBanner, 200);
        })();
    </script>
        <p style="margin: 0 0 1rem 0; font-size: 0.9rem; line-height: 1.5;">
            Questo sito utilizza Google Analytics 4, Google Signals e dati demografici per migliorare l'esperienza utente. 
            I dati vengono raccolti solo con il tuo consenso esplicito.
        </p>
        <div style="display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center;">
            <a href="policy.html" style="color: #FFC928; text-decoration: underline; font-size: 0.85rem;" id="cookie-policy-link">Privacy Policy</a>
            <button id="cookie-reject" style="padding: 0.6rem 1.5rem; background: transparent; border: 2px solid #FFC928; color: #FFC928; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                Rifiuta
            </button>
            <button id="cookie-accept" style="padding: 0.6rem 1.5rem; background: #FFC928; border: 2px solid #FFC928; color: #000000; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                Accetta
            </button>
        </div>
    </div>

    <button class="scroll-top" aria-label="Torna all'inizio">
        <i class="fas fa-chevron-up"></i>
    </button>
    
    <!-- Bottone modifica consenso cookie -->
    <button class="cookie-settings-btn" id="cookieSettingsBtn" aria-label="Impostazioni cookie">
        <i class="fas fa-cookie"></i>
    </button>
    
    <!-- Banner modifica consenso -->
    <div id="cookie-settings-banner" class="cookie-settings-banner" style="display: none;">
        <div class="cookie-settings-content">
            <h3 class="cookie-settings-title">Gestisci le tue preferenze cookie</h3>
            <p class="cookie-settings-desc">Puoi modificare la tua scelta in qualsiasi momento.</p>
            <div class="cookie-settings-status">
                <p id="cookie-settings-status-text">Stato attuale: <strong id="cookie-current-status">Non impostato</strong></p>
            </div>
            <div class="cookie-settings-buttons">
                <button id="cookie-settings-accept" class="cookie-settings-btn-action cookie-settings-accept">
                    Accetta
                </button>
                <button id="cookie-settings-reject" class="cookie-settings-btn-action cookie-settings-reject">
                    Rifiuta
                </button>
                <button id="cookie-settings-close" class="cookie-settings-btn-action cookie-settings-close">
                    Chiudi
                </button>
            </div>
        </div>
    </div>
    <div id="cookie-settings-overlay" class="cookie-settings-overlay" style="display: none;"></div>

    <script>
        // Inizializza dataLayer PRIMA di qualsiasi altro codice
        window.dataLayer = window.dataLayer || [];
        
        // Dati dei vini (verranno caricati da vini.txt o definiti qui)
        const vini = [
            { nome: "Falanghina IGP Campania 13%", tono: "bianco", regione: "campania", prezzo: "18,00" },
            { nome: "Pinot Grigio DOC Friuli 12,5%", tono: "bianco", regione: "veneto", prezzo: "20,00" },
            { nome: "Vermentino DOCG Sardegna 13%", tono: "bianco", regione: "sicilia", prezzo: "22,00" },
            { nome: "Gavi DOCG Piemonte 12,5%", tono: "bianco", regione: "piemonte", prezzo: "25,00" },
            { nome: "Greco di Tufo DOCG Campania 13%", tono: "bianco", regione: "campania", prezzo: "28,00" },
            { nome: "Aglianico IGP Campania 14%", tono: "rosso", regione: "campania", prezzo: "18,00" },
            { nome: "Chianti Classico DOCG Toscana 13,5%", tono: "rosso", regione: "toscana", prezzo: "25,00" },
            { nome: "Barolo DOCG Piemonte 14%", tono: "rosso", regione: "piemonte", prezzo: "45,00" },
            { nome: "Montepulciano d'Abruzzo DOC 13%", tono: "rosso", regione: "toscana", prezzo: "15,00" },
            { nome: "Nero d'Avola Sicilia DOC 13,5%", tono: "rosso", regione: "sicilia", prezzo: "20,00" },
            { nome: "Brunello di Montalcino DOCG 14,5%", tono: "rosso", regione: "toscana", prezzo: "55,00" },
            { nome: "Barbaresco DOCG Piemonte 14%", tono: "rosso", regione: "piemonte", prezzo: "48,00" },
            { nome: "Amarone della Valpolicella DOCG 15%", tono: "rosso", regione: "veneto", prezzo: "42,00" },
            { nome: "Prosecco DOCG Veneto 11,5%", tono: "prosecco", regione: "veneto", prezzo: "16,00" },
            { nome: "Prosecco Superiore DOCG 12%", tono: "prosecco", regione: "veneto", prezzo: "22,00" },
            { nome: "Champagne Brut 12%", tono: "champagne", regione: "veneto", prezzo: "35,00" },
            { nome: "Champagne Rosé 12,5%", tono: "champagne", regione: "toscana", prezzo: "38,00" },
            { nome: "Rosè di Toscana IGT 12%", tono: "rosè", regione: "toscana", prezzo: "18,00" },
            { nome: "Cerasuolo d'Abruzzo DOC 13%", tono: "rosè", regione: "campania", prezzo: "16,00" },
            { nome: "Rosè Sicilia DOC 12,5%", tono: "rosè", regione: "sicilia", prezzo: "17,00" }
        ];

        // Variabili globali
        const filterButtons = document.querySelectorAll('.filter-btn');
        const wineGrid = document.getElementById('wineGrid');
        const searchInput = document.getElementById('menuSearchInput');
        let selectedTono = new Set(['all']);
        let selectedRegione = new Set(['all']);
        let searchTerms = [];
        
        // Gestione preferiti con localStorage
        const FAVORITES_KEY = 'decanter_favorites';
        
        function getFavorites() {
            try {
                const favorites = localStorage.getItem(FAVORITES_KEY);
                if (!favorites || favorites === 'null' || favorites === 'undefined') {
                    return [];
                }
                const parsed = JSON.parse(favorites);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error('Errore nel recupero dei preferiti:', e);
                return [];
            }
        }
        
        function saveFavorites(favorites) {
            try {
                const jsonData = JSON.stringify(favorites);
                
                // Salva in localStorage
                localStorage.setItem(FAVORITES_KEY, jsonData);
                
                // Se si usa file://, salva anche in sessionStorage come fallback
                if (window.location.protocol === 'file:') {
                    try {
                        sessionStorage.setItem(FAVORITES_KEY, jsonData);
                    } catch (e) {
                        // Ignora errori
                    }
                }
            } catch (e) {
                console.error('Errore nel salvataggio dei preferiti:', e);
            }
        }
        
        function isFavorite(wineName) {
            const favorites = getFavorites();
            return favorites.some(fav => fav.nome === wineName);
        }
        
        function addToFavorites(vino) {
            const favorites = getFavorites();
            if (!isFavorite(vino.nome)) {
                favorites.push(vino);
                saveFavorites(favorites);
                return true;
            }
            return false;
        }
        
        function removeFromFavorites(wineName) {
            const favorites = getFavorites();
            const filtered = favorites.filter(fav => fav.nome !== wineName);
            saveFavorites(filtered);
            return filtered.length < favorites.length;
        }
        
        function toggleFavorite(vino, button) {
            if (isFavorite(vino.nome)) {
                // Rimuove dai preferiti
                removeFromFavorites(vino.nome);
                button.classList.remove('active');
                button.setAttribute('aria-label', 'Aggiungi ai preferiti');
                
                // Google Analytics 4: traccia la rimozione dai preferiti
                try {
                    if (window.sendGA4Event) {
                        window.sendGA4Event('favorite_removed', {
                            'product_name': vino.nome,
                            'product_type': vino.tono,
                            'product_region': vino.regione,
                            'product_price': vino.prezzo
                        });
                    } else {
                        window.dataLayer = window.dataLayer || [];
                        window.dataLayer.push({
                            'event': 'favorite_removed',
                            'product_name': vino.nome,
                            'product_type': vino.tono,
                            'product_region': vino.regione,
                            'product_price': vino.prezzo
                        });
                    }
                } catch (e) {
                    // Silenzioso: non bloccare l'esperienza utente se GA4 fallisce
                }
            } else {
                // Aggiunge ai preferiti
                addToFavorites(vino);
                button.classList.add('active');
                button.setAttribute('aria-label', 'Rimuovi dai preferiti');
                
                // Google Analytics 4: traccia l'aggiunta ai preferiti
                try {
                    // Usa la funzione helper che aspetta che GA4 sia pronto
                    if (window.sendGA4Event) {
                        window.sendGA4Event('favorite_added', {
                            'product_name': vino.nome,
                            'product_type': vino.tono,
                            'product_region': vino.regione,
                            'product_price': vino.prezzo
                        });
                    } else {
                        // Fallback se la funzione helper non è ancora disponibile
                        window.dataLayer = window.dataLayer || [];
                        window.dataLayer.push({
                            'event': 'favorite_added',
                            'product_name': vino.nome,
                            'product_type': vino.tono,
                            'product_region': vino.regione,
                            'product_price': vino.prezzo
                        });
                    }
                } catch (e) {
                    // Silenzioso: non bloccare l'esperienza utente se GA4 fallisce
                }
            }
        }

        // Funzione helper per capitalizzare
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Inizializza la griglia dei vini
        function initWineGrid() {
            wineGrid.innerHTML = '';
            vini.forEach((vino, index) => {
                const wineItem = document.createElement('div');
                wineItem.className = 'wine-item menu-item';
                wineItem.setAttribute('data-tono', vino.tono);
                wineItem.setAttribute('data-regione', vino.regione);
                const isFav = isFavorite(vino.nome);
                wineItem.innerHTML = `
                    <button class="favorite-btn ${isFav ? 'active' : ''}" 
                            aria-label="${isFav ? 'Rimuovi dai preferiti' : 'Aggiungi ai preferiti'}"
                            data-wine-name="${vino.nome}">
                        <i class="${isFav ? 'fas fa-heart' : 'far fa-heart'}"></i>
                    </button>
                    <div class="menu-item-header">
                        <span class="menu-item-name">${vino.nome}</span>
                        <span class="menu-item-price">${vino.prezzo}&nbsp;&euro;</span>
                    </div>
                    <p class="menu-item-desc">
                        ${capitalize(vino.tono)} - ${capitalize(vino.regione)}
                    </p>
                    <div class="wine-item-tags">
                        <span class="wine-tag wine-tag--tono-${vino.tono}">${capitalize(vino.tono)}</span>
                        <span class="wine-tag wine-tag--regione-${vino.regione}">${capitalize(vino.regione)}</span>
                        <button class="details-btn" 
                                aria-label="Mostra dettagli"
                                data-wine-index="${index}">
                            INFO
                        </button>
                    </div>
                `;
                wineGrid.appendChild(wineItem);
                
                // Aggiungi event listener al pulsante preferiti
                const favoriteBtn = wineItem.querySelector('.favorite-btn');
                favoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(vino, favoriteBtn);
                    // Aggiorna l'icona
                    const icon = favoriteBtn.querySelector('i');
                    if (favoriteBtn.classList.contains('active')) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }
                });
                
                // Aggiungi event listener al pulsante dettagli
                const detailsBtn = wineItem.querySelector('.details-btn');
                if (detailsBtn) {
                    detailsBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showWineDetails(vino);
                    });
                }
            });
        }
        
        // Funzione per generare informazioni dettagliate del vino
        function getWineDetails(vino) {
            const details = {
                nome: vino.nome,
                tono: vino.tono,
                regione: vino.regione,
                prezzo: vino.prezzo,
                descrizione: '',
                caratteristiche: '',
                abbinamenti: ''
            };
            
            // Descrizioni basate sul tipo di vino
            const descrizioni = {
                'bianco': 'Vino bianco elegante e raffinato, perfetto per accompagnare piatti di pesce e formaggi freschi.',
                'rosso': 'Vino rosso strutturato e corposo, ideale per carni rosse e formaggi stagionati.',
                'rosè': 'Vino rosato fresco e fruttato, versatile e perfetto per aperitivi e piatti leggeri.',
                'prosecco': 'Bollicine italiane fresche e vivaci, ideali per celebrare momenti speciali.',
                'champagne': 'Champagne pregiato, simbolo di eleganza e raffinatezza.'
            };
            
            const caratteristiche = {
                'bianco': 'Colore giallo paglierino, profumo delicato e floreale, sapore fresco e minerale.',
                'rosso': 'Colore rosso rubino intenso, profumo complesso e speziato, sapore pieno e persistente.',
                'rosè': 'Colore rosa salmone, profumo fruttato e floreale, sapore fresco e leggero.',
                'prosecco': 'Perlage fine e persistente, profumo di frutta bianca, sapore secco e armonioso.',
                'champagne': 'Perlage elegante e cremoso, profumo complesso, sapore raffinato e persistente.'
            };
            
            const abbinamenti = {
                'bianco': 'Pesce, frutti di mare, formaggi freschi, verdure, pasta al pesce.',
                'rosso': 'Carni rosse, selvaggina, formaggi stagionati, pasta al ragù, funghi.',
                'rosè': 'Aperitivi, insalate, pesce, pizza, formaggi freschi.',
                'prosecco': 'Aperitivi, antipasti, pesce, formaggi freschi, dolci non troppo dolci.',
                'champagne': 'Ostriche, caviale, formaggi cremosi, dolci raffinati, aperitivi.'
            };
            
            details.descrizione = descrizioni[vino.tono] || 'Vino di qualità, selezionato per la nostra carta.';
            details.caratteristiche = caratteristiche[vino.tono] || 'Vino pregiato con caratteristiche uniche.';
            details.abbinamenti = abbinamenti[vino.tono] || 'Versatile, si abbina a diversi piatti.';
            
            return details;
        }
        
        // Funzione per mostrare il banner con i dettagli
        function showWineDetails(vino) {
            const details = getWineDetails(vino);
            
            // Google Analytics 4: traccia l'apertura del banner dettagli prodotto
            try {
                // Usa la funzione helper che aspetta che GA4 sia pronto
                if (window.sendGA4Event) {
                    window.sendGA4Event('product_details_view', {
                        'product_name': vino.nome,
                        'product_type': vino.tono,
                        'product_region': vino.regione,
                        'product_price': vino.prezzo
                    });
                } else {
                    // Fallback se la funzione helper non è ancora disponibile
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({
                        'event': 'product_details_view',
                        'product_name': vino.nome,
                        'product_type': vino.tono,
                        'product_region': vino.regione,
                        'product_price': vino.prezzo
                    });
                }
            } catch (e) {
                console.error('Errore nell\'invio evento GA4:', e);
            }
            
            // Crea o aggiorna il banner
            let banner = document.getElementById('wineDetailsBanner');
            let overlay = document.getElementById('wineDetailsOverlay');
            
            if (!banner) {
                // Crea il banner se non esiste
                overlay = document.createElement('div');
                overlay.id = 'wineDetailsOverlay';
                overlay.className = 'wine-details-overlay';
                overlay.addEventListener('click', closeWineDetails);
                
                banner = document.createElement('div');
                banner.id = 'wineDetailsBanner';
                banner.className = 'wine-details-banner';
                banner.innerHTML = `
                    <div class="wine-details-header">
                        <h3 class="wine-details-title"></h3>
                        <button class="wine-details-close" aria-label="Chiudi dettagli">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="wine-details-content">
                        <div class="wine-details-section">
                            <span class="wine-details-label">Descrizione</span>
                            <p class="wine-details-value" id="wine-desc"></p>
                        </div>
                        <div class="wine-details-section">
                            <span class="wine-details-label">Caratteristiche</span>
                            <p class="wine-details-value" id="wine-char"></p>
                        </div>
                        <div class="wine-details-section">
                            <span class="wine-details-label">Abbinamenti Consigliati</span>
                            <p class="wine-details-value" id="wine-pair"></p>
                        </div>
                        <div class="wine-details-section">
                            <span class="wine-details-label">Regione</span>
                            <p class="wine-details-value" id="wine-region"></p>
                        </div>
                        <div class="wine-details-price" id="wine-price"></div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                document.body.appendChild(banner);
                
                // Event listener per il pulsante chiudi
                const closeBtn = banner.querySelector('.wine-details-close');
                closeBtn.addEventListener('click', closeWineDetails);
                
                // Chiudi con ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && banner.classList.contains('open')) {
                        closeWineDetails();
                    }
                });
            }
            
            // Aggiorna il contenuto
            banner.querySelector('.wine-details-title').textContent = details.nome;
            document.getElementById('wine-desc').textContent = details.descrizione;
            document.getElementById('wine-char').textContent = details.caratteristiche;
            document.getElementById('wine-pair').textContent = details.abbinamenti;
            document.getElementById('wine-region').textContent = capitalize(details.regione);
            document.getElementById('wine-price').textContent = details.prezzo + ' €';
            
            // Mostra il banner
            setTimeout(() => {
                overlay.classList.add('show');
                banner.classList.add('open');
            }, 10);
            
            // Previeni scroll del body quando il banner è aperto
            document.body.style.overflow = 'hidden';
        }
        
        // Funzione per chiudere il banner
        function closeWineDetails() {
            const banner = document.getElementById('wineDetailsBanner');
            const overlay = document.getElementById('wineDetailsOverlay');
            
            if (banner && overlay) {
                banner.classList.remove('open');
                overlay.classList.remove('show');
                
                // Ripristina scroll del body
                document.body.style.overflow = '';
            }
        }

        // Parsing termini di ricerca (logica AND)
        function parseSearchTerms(searchText) {
            return searchText
                .toLowerCase()
                .trim()
                .split(/\s+/)
                .filter(term => term.length > 0);
        }

        // Verifica match ricerca (logica AND: tutti i termini devono essere presenti)
        function matchesSearchTerms(item, terms) {
            if (terms.length === 0) return true;
            
            const nameEl = item.querySelector('.menu-item-name');
            const descEl = item.querySelector('.menu-item-desc');
            const name = nameEl ? nameEl.textContent.toLowerCase() : '';
            const description = descEl ? descEl.textContent.toLowerCase() : '';
            
            // AND: tutti i termini devono essere presenti
            // Un termine può essere nel nome O nella descrizione (OR interno)
            // Ma TUTTI i termini devono essere trovati (AND tra termini)
            return terms.every(term => {
                return name.includes(term) || description.includes(term);
            });
        }

        // Funzione per applicare i filtri combinati
        function applyFilters() {
            const wineItems = document.querySelectorAll('.wine-item');
            let visibleCount = 0;
            
            wineItems.forEach(item => {
                const itemTono = item.getAttribute('data-tono');
                const itemRegione = item.getAttribute('data-regione');
                
                // Logica OR per tono: mostra se "all" è selezionato O se il tono dell'item è selezionato
                const tonoMatch = selectedTono.has('all') || selectedTono.has(itemTono);
                
                // Logica OR per regione: mostra se "all" è selezionato O se la regione dell'item è selezionata
                const regioneMatch = selectedRegione.has('all') || selectedRegione.has(itemRegione);
                
                // Combinazione AND tra filtri categoria
                const categoryMatch = tonoMatch && regioneMatch;
                
                // Verifica ricerca testuale (AND)
                const searchMatch = matchesSearchTerms(item, searchTerms);
                
                // COMBINAZIONE FINALE: entrambi i filtri devono essere veri (AND)
                const shouldShow = categoryMatch && searchMatch;
                
                if (shouldShow) {
                    item.classList.remove('hidden', 'hiding');
                    item.classList.add('showing');
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.classList.remove('showing');
                    item.classList.add('hiding');
                    setTimeout(() => {
                        item.classList.add('hidden');
                        item.style.display = 'none';
                    }, 300);
                }
            });
            
            // Tracking: verifica se la ricerca non ha dato risultati
            if (searchTerms.length > 0 && visibleCount === 0) {
                const searchText = searchInput ? searchInput.value : '';
                trackSearchNoResults(searchText);
            }
        }
        
        // Funzione per salvare e mostrare ricerche senza risultati
        const NO_RESULTS_KEY = 'decanter_no_results_searches';
        
        function getNoResultsSearches() {
            try {
                const searches = localStorage.getItem(NO_RESULTS_KEY);
                if (!searches || searches === 'null' || searches === 'undefined') {
                    return [];
                }
                const parsed = JSON.parse(searches);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }
        
        function saveNoResultsSearch(searchText) {
            try {
                const searches = getNoResultsSearches();
                // Aggiungi solo se non è già presente (evita duplicati)
                if (!searches.includes(searchText.trim())) {
                    searches.push(searchText.trim());
                    // Mantieni solo le ultime 50 ricerche
                    if (searches.length > 50) {
                        searches.shift();
                    }
                    localStorage.setItem(NO_RESULTS_KEY, JSON.stringify(searches));
                    updateNoResultsDisplay();
                }
            } catch (e) {
                // Ignora errori
            }
        }
        
        function updateNoResultsDisplay() {
            const noResultsSection = document.getElementById('noResultsSection');
            const noResultsList = document.getElementById('noResultsList');
            
            if (!noResultsSection || !noResultsList) return;
            
            const searches = getNoResultsSearches();
            
            if (searches.length > 0) {
                noResultsSection.style.display = 'block';
                noResultsList.innerHTML = '';
                searches.forEach(search => {
                    const li = document.createElement('li');
                    li.textContent = search;
                    noResultsList.appendChild(li);
                });
            } else {
                noResultsSection.style.display = 'none';
            }
        }
        
        // Funzione per tracciare ricerche senza risultati
        function trackSearchNoResults(searchText) {
            const trimmedSearch = searchText.trim();
            if (trimmedSearch.length === 0) return;
            
            // Salva la ricerca senza risultati
            saveNoResultsSearch(trimmedSearch);
            
            // Traccia in GA4
            try {
                if (window.sendGA4Event) {
                    window.sendGA4Event('search_no_results', {
                        'search_term': trimmedSearch,
                        'search_type': 'wine_search'
                    });
                } else {
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({
                        'event': 'search_no_results',
                        'search_term': trimmedSearch,
                        'search_type': 'wine_search'
                    });
                }
            } catch (e) {
                // Silenzioso: non bloccare l'esperienza utente
            }
        }
        
        // Funzione per tracciare le ricerche (con risultati)
        function trackSearch(searchText, resultCount) {
            try {
                if (window.sendGA4Event) {
                    window.sendGA4Event('search', {
                        'search_term': searchText,
                        'search_results': resultCount,
                        'search_type': 'wine_search'
                    });
                } else {
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({
                        'event': 'search',
                        'search_term': searchText,
                        'search_results': resultCount,
                        'search_type': 'wine_search'
                    });
                }
            } catch (e) {
                // Silenzioso: non bloccare l'esperienza utente
            }
        }

        // Funzione per tracciare i click sui filtri
        function trackFilterClick(filterType, category, isActive) {
            try {
                if (window.sendGA4Event) {
                    window.sendGA4Event('filter_click', {
                        'filter_type': filterType,
                        'filter_category': category,
                        'filter_action': isActive ? 'activated' : 'deactivated'
                    });
                } else {
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({
                        'event': 'filter_click',
                        'filter_type': filterType,
                        'filter_category': category,
                        'filter_action': isActive ? 'activated' : 'deactivated'
                    });
                }
            } catch (e) {
                // Silenzioso: non bloccare l'esperienza utente
            }
        }

        // Gestione click sui pulsanti filtro
        filterButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const filterType = button.getAttribute('data-filter-type');
                const category = button.getAttribute('data-category');
                const filterSet = filterType === 'tono' ? selectedTono : selectedRegione;
                const buttons = Array.from(filterButtons).filter(btn => 
                    btn.getAttribute('data-filter-type') === filterType
                );
                
                let isActivating = false;
                
                if (category === 'all') {
                    // Se clicco "Tutto", deseleziono tutto e seleziono solo "all"
                    filterSet.clear();
                    filterSet.add('all');
                    buttons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    isActivating = true;
                } else {
                    // Rimuovo "all" se presente
                    filterSet.delete('all');
                    
                    // Toggle della categoria
                    if (filterSet.has(category)) {
                        filterSet.delete(category);
                        button.classList.remove('active');
                        isActivating = false;
                    } else {
                        filterSet.add(category);
                        button.classList.add('active');
                        isActivating = true;
                    }
                    
                    // Se nessuna categoria è selezionata, seleziono "all" di default
                    if (filterSet.size === 0) {
                        filterSet.add('all');
                        const allButton = buttons.find(btn => btn.getAttribute('data-category') === 'all');
                        if (allButton) allButton.classList.add('active');
                    } else {
                        // Rimuovo active da "Tutto" se altre categorie sono selezionate
                        const allButton = buttons.find(btn => btn.getAttribute('data-category') === 'all');
                        if (allButton) allButton.classList.remove('active');
                    }
                }
                
                // Traccia il click sul filtro
                trackFilterClick(filterType, category, isActivating);
                
                // Applica il filtro
                applyFilters();
            });
        });

        // Event listener per la barra di ricerca
        if (searchInput) {
            let searchTimeout;
            let lastSearchText = '';
            
            searchInput.addEventListener('input', (e) => {
                const searchText = e.target.value;
                searchTerms = parseSearchTerms(searchText);
                
                // Applica i filtri
                applyFilters();
                
                // Traccia la ricerca dopo un breve delay (per evitare troppi eventi)
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    if (searchText.trim().length > 0 && searchText !== lastSearchText) {
                        const visibleItems = document.querySelectorAll('.wine-item:not(.hidden)');
                        const resultCount = visibleItems.length;
                        
                        if (resultCount > 0) {
                            trackSearch(searchText, resultCount);
                        }
                        
                        lastSearchText = searchText;
                    }
                }, 500); // Attendi 500ms dopo l'ultimo input
            });
            
            // Stili focus
            searchInput.addEventListener('focus', function() {
                this.style.borderColor = '#8B4513';
                this.style.boxShadow = '0 0 0 3px rgba(212, 175, 55, 0.1)';
            });
            
            searchInput.addEventListener('blur', function() {
                this.style.borderColor = 'rgba(255, 201, 40, 0.5)';
                this.style.boxShadow = 'none';
            });
        }

        // Scroll to top button
        (function() {
            const btn = document.querySelector('.scroll-top');
            if (!btn) return;
            
            btn.addEventListener('click', function () {
                // Tracking click su "Torna all'inizio"
                try {
                    if (window.sendGA4Event) {
                        window.sendGA4Event('scroll_to_top_click', {
                            'button_name': 'Torna all\'inizio',
                            'page_location': window.location.pathname
                        });
                    } else {
                        window.dataLayer = window.dataLayer || [];
                        window.dataLayer.push({
                            'event': 'scroll_to_top_click',
                            'button_name': 'Torna all\'inizio',
                            'page_location': window.location.pathname
                        });
                    }
                } catch (e) {
                    // Silenzioso: non bloccare l'esperienza utente
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            const scrollThreshold = 200;
            
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > scrollThreshold) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            });
        })();

        // Registrazione Service Worker (solo se non si usa file://)
        if ('serviceWorker' in navigator && (location.protocol === 'http:' || location.protocol === 'https:')) {
            window.addEventListener('load', function() {
                // Usa percorso relativo per compatibilità con GitHub Pages (repository non in root)
                const swPath = './service-worker.js';
                navigator.serviceWorker.register(swPath)
                    .then(function(registration) {
                        // Service Worker registrato correttamente
                    })
                    .catch(function(error) {
                        // Errore silenzioso: non bloccare l'esperienza utente
                    });
            });
        }
        
        // Tracking click bottoni social
        (function() {
            function trackSocialClick(buttonName, buttonType) {
                try {
                    if (window.sendGA4Event) {
                        window.sendGA4Event('social_click', {
                            'button_name': buttonName,
                            'button_type': buttonType
                        });
                    } else {
                        window.dataLayer = window.dataLayer || [];
                        window.dataLayer.push({
                            'event': 'social_click',
                            'button_name': buttonName,
                            'button_type': buttonType
                        });
                    }
                } catch (e) {
                    // Silenzioso: non bloccare l'esperienza utente
                }
            }
            
            // Attendi che il DOM sia pronto
            function initSocialTracking() {
                // WhatsApp
                const whatsappBtn = document.querySelector('.bottom-bar-btn--wa');
                if (whatsappBtn) {
                    whatsappBtn.addEventListener('click', function() {
                        trackSocialClick('WhatsApp', 'whatsapp');
                    });
                }
                
                // Instagram
                const instagramBtn = document.querySelector('.bottom-bar-btn--ig');
                if (instagramBtn) {
                    instagramBtn.addEventListener('click', function() {
                        trackSocialClick('Instagram', 'instagram');
                    });
                }
                
                // Telefono
                const phoneBtn = document.querySelector('.bottom-bar-btn--call');
                if (phoneBtn) {
                    phoneBtn.addEventListener('click', function() {
                        trackSocialClick('Chiama', 'phone');
                    });
                }
                
                // Mappe (se presente)
                const mapsBtn = document.querySelector('.bottom-bar-btn--maps, .maps-btn, [href*="maps.google"], [href*="google.com/maps"]');
                if (mapsBtn) {
                    mapsBtn.addEventListener('click', function() {
                        trackSocialClick('Mappe', 'maps');
                    });
                }
            }
            
            // Inizializza quando il DOM è pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSocialTracking);
            } else {
                initSocialTracking();
            }
        })();

        // Animazione dello sfondo vino basata sullo scroll
        (function() {
            const wineBg = document.querySelector('.wine-background');
            if (!wineBg) return;
            
            const wavePath = wineBg.querySelector('clipPath path');
            const animateElement = wineBg.querySelector('animate');
            
            const flatWavePath = 'M64 246 L64 90 L156 90 L156 246 Z';
            
            const animationValues = `
                            M64 246 L64 90
                            C82 84, 100 96, 110 90
                            C120 84, 138 96, 156 90
                            L156 246 Z;
                            M64 246 L64 90
                            C82 96, 100 84, 110 90
                            C120 96, 138 84, 156 90
                            L156 246 Z;
                            M64 246 L64 90
                            C82 84, 100 96, 110 90
                            C120 84, 138 96, 156 90
                            L156 246 Z
                            `;
            
            if (wavePath && animateElement) {
                animateElement.remove();
                wavePath.setAttribute('d', flatWavePath);
            }
            
            let scrollTimeout;
            
            function updateWinePosition() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const documentHeight = document.documentElement.scrollHeight;
                const viewportHeight = window.innerHeight;
                const maxScroll = documentHeight - viewportHeight;
                
                if (maxScroll <= 0) {
                    wineBg.style.top = '50%';
                    wineBg.style.transform = 'translate(-50%, -50%) scale(3.0)';
                    return;
                }
                
                const scrollPercent = scrollTop / maxScroll;
                const topPosition = 100 - (scrollPercent * 100);
                
                wineBg.style.top = topPosition + 'vh';
                wineBg.style.transform = 'translate(-50%, 0) scale(3.0)';
            }
            
            function startScrollAnimation() {
                if (wavePath) {
                    const existingAnimate = wavePath.querySelector('animate');
                    if (!existingAnimate) {
                        wavePath.removeAttribute('d');
                        
                        const newAnimate = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
                        newAnimate.setAttribute('attributeName', 'd');
                        newAnimate.setAttribute('dur', '2.6s');
                        newAnimate.setAttribute('repeatCount', 'indefinite');
                        newAnimate.setAttribute('values', animationValues.trim());
                        wavePath.appendChild(newAnimate);
                    }
                }
                
                clearTimeout(scrollTimeout);
            }
            
            function stopScrollAnimation() {
                if (wavePath) {
                    const existingAnimate = wavePath.querySelector('animate');
                    if (existingAnimate) {
                        const intermediatePath = 'M64 246 L64 90 C82 90, 100 90, 110 90 C120 90, 138 90, 156 90 L156 246 Z';
                        
                        existingAnimate.remove();
                        wavePath.setAttribute('d', intermediatePath);
                        
                        requestAnimationFrame(function() {
                            requestAnimationFrame(function() {
                                wavePath.setAttribute('d', flatWavePath);
                            });
                        });
                    }
                }
            }
            
            updateWinePosition();
            
            let ticking = false;
            window.addEventListener('scroll', function() {
                startScrollAnimation();
                
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        updateWinePosition();
                        ticking = false;
                    });
                    ticking = true;
                }
                
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(stopScrollAnimation, 500);
            }, { passive: true });
            
            window.addEventListener('resize', function() {
                updateWinePosition();
            });
        })();

        // Verifica e forza ricaricamento Font Awesome se necessario
        function verifyFontAwesome() {
            let attempts = 0;
            const maxAttempts = 3;
            
            function checkAndReload() {
                attempts++;
                const testIcon = document.createElement('i');
                testIcon.className = 'fas fa-check';
                testIcon.style.position = 'absolute';
                testIcon.style.left = '-9999px';
                testIcon.style.fontSize = '1px';
                testIcon.style.opacity = '0';
                document.body.appendChild(testIcon);
                
                setTimeout(function() {
                    const style = window.getComputedStyle(testIcon, ':before');
                    const fontFamily = style.getPropertyValue('font-family');
                    const content = style.getPropertyValue('content');
                    
                    // Verifica se Font Awesome è caricato
                    const isLoaded = fontFamily && (fontFamily.includes('Font Awesome') || fontFamily.includes('FontAwesome')) && content && content !== 'none' && content !== '""';
                    
                    if (!isLoaded && attempts < maxAttempts) {
                        console.warn('Font Awesome non caricato correttamente. Tentativo', attempts, 'di', maxAttempts);
                        
                        // Rimuovi il link esistente
                        const existingLink = document.getElementById('fontAwesomeCSS');
                        if (existingLink) {
                            existingLink.remove();
                        }
                        
                        // Prova il fallback locale
                        const newLink = document.createElement('link');
                        newLink.id = 'fontAwesomeCSS';
                        newLink.rel = 'stylesheet';
                        newLink.href = 'fonts/font-awesome/css/all.min.css';
                        newLink.onerror = function() {
                            // Se anche il fallback locale fallisce, riprova CDN
                            this.onerror = null;
                            this.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css?v=' + Date.now();
                            this.crossOrigin = 'anonymous';
                        };
                        document.head.appendChild(newLink);
                        
                        // Riprova dopo un breve delay
                        setTimeout(checkAndReload, 500);
                    } else if (!isLoaded) {
                        console.error('Font Awesome non è riuscito a caricarsi dopo', maxAttempts, 'tentativi');
                    }
                    
                    if (document.body.contains(testIcon)) {
                        document.body.removeChild(testIcon);
                    }
                }, 300);
            }
            
            // Inizia il controllo dopo un breve delay
            setTimeout(checkAndReload, 500);
        }

        // Inizializza la griglia quando il DOM è pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Verifica Font Awesome
            verifyFontAwesome();
            
            initWineGrid();
            applyFilters();
            
            // Inizializza la sezione ricerche senza risultati
            updateNoResultsDisplay();
            
            // Toggle per mostrare/nascondere ricerche senza risultati
            const noResultsToggle = document.getElementById('noResultsToggle');
            const noResultsContent = document.getElementById('noResultsContent');
            if (noResultsToggle && noResultsContent) {
                noResultsToggle.addEventListener('click', function() {
                    const isExpanded = noResultsContent.style.display !== 'none';
                    noResultsContent.style.display = isExpanded ? 'none' : 'block';
                    noResultsToggle.classList.toggle('expanded', !isExpanded);
                });
            }

            // Toggle unica per aprire/chiudere i filtri (Tono + Regione insieme)
            const filtersWrapper = document.querySelector('.filters-wrapper');
            const filtersHeader = document.querySelector('.filters-header');
            const filtersHandle = document.querySelector('.filters-handle');

            if (filtersWrapper && filtersHeader) {
                filtersWrapper.classList.add('collapsed');

                // Funzione per scroll automatico quando si apre
                function scrollToFilters() {
                    if (!filtersWrapper.classList.contains('collapsed')) {
                        setTimeout(function() {
                            const rect = filtersWrapper.getBoundingClientRect();
                            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                            const elementTop = rect.top + scrollTop;
                            const elementCenter = elementTop + (rect.height / 2);
                            const viewportHeight = window.innerHeight;
                            const targetScroll = elementCenter - (viewportHeight / 2);
                            
                            window.scrollTo({
                                top: Math.max(0, targetScroll),
                                behavior: 'smooth'
                            });
                        }, 100); // Piccolo delay per permettere l'animazione di apertura
                    }
                }

                // Click sull'header
                filtersHeader.addEventListener('click', function (e) {
                    e.preventDefault();
                    const wasCollapsed = filtersWrapper.classList.contains('collapsed');
                    filtersWrapper.classList.toggle('collapsed');
                    
                    // Se si sta aprendo (era chiusa), scrolla
                    if (wasCollapsed) {
                        scrollToFilters();
                    }
                });

                // Click sull'handle
                if (filtersHandle) {
                    filtersHandle.addEventListener('click', function (e) {
                        e.preventDefault();
                        const wasCollapsed = filtersWrapper.classList.contains('collapsed');
                        filtersWrapper.classList.toggle('collapsed');
                        
                        // Se si sta aprendo (era chiusa), scrolla
                        if (wasCollapsed) {
                            scrollToFilters();
                        }
                    });
                }
            }
        });
    </script>
    
    <!-- Google Analytics Consent Management -->
    <script src="ga-consent.js"></script>
    
    <!-- Inizializza dataLayer anche se GA4 non è ancora caricato -->
    <script>
        // Assicura che dataLayer esista sempre (per eventi in coda)
        window.dataLayer = window.dataLayer || [];
        
        // Gestione bottone e banner modifica consenso cookie
        (function() {
            // Usa la chiave globale da ga-consent.js, fallback a 'cookie_consent_idedecanter' se non disponibile
            const CONSENT_KEY = window.CONSENT_KEY || 'cookie_consent_idedecanter';
            const settingsBtn = document.getElementById('cookieSettingsBtn');
            const settingsBanner = document.getElementById('cookie-settings-banner');
            const settingsOverlay = document.getElementById('cookie-settings-overlay');
            const acceptBtn = document.getElementById('cookie-settings-accept');
            const rejectBtn = document.getElementById('cookie-settings-reject');
            const closeBtn = document.getElementById('cookie-settings-close');
            const statusText = document.getElementById('cookie-current-status');
            const cookieBanner = document.getElementById('cookie-banner');
            
            if (!settingsBtn || !settingsBanner || !settingsOverlay) return;
            
            // Funzione per aggiornare lo stato visualizzato
            function updateConsentStatus() {
                const consent = localStorage.getItem(CONSENT_KEY);
                if (statusText) {
                    if (consent === 'granted') {
                        statusText.textContent = 'Accettato';
                        statusText.style.color = '#4CAF50';
                    } else if (consent === 'denied') {
                        statusText.textContent = 'Rifiutato';
                        statusText.style.color = '#F44336';
                    } else {
                        statusText.textContent = 'Non impostato';
                        statusText.style.color = '#FFC928';
                    }
                }
            }
            
            // Funzione per mostrare/nascondere il bottone in base al banner cookie
            function toggleSettingsButton() {
                if (cookieBanner && cookieBanner.style.display !== 'none') {
                    // Banner cookie visibile, nascondi bottone
                    settingsBtn.classList.add('hidden');
                } else {
                    // Banner cookie non visibile, mostra bottone
                    settingsBtn.classList.remove('hidden');
                }
            }
            
            // Controlla periodicamente se il banner cookie è visibile
            setInterval(toggleSettingsButton, 500);
            toggleSettingsButton(); // Controllo iniziale
            
            // Funzione per aprire il banner modifica consenso
            function openSettingsBanner() {
                updateConsentStatus();
                settingsBanner.style.display = 'block';
                settingsOverlay.style.display = 'block';
                
                setTimeout(function() {
                    settingsBanner.classList.add('open');
                    settingsOverlay.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }, 10);
            }
            
            // Funzione per chiudere il banner modifica consenso
            function closeSettingsBanner() {
                settingsBanner.classList.remove('open');
                settingsOverlay.classList.remove('show');
                
                setTimeout(function() {
                    settingsBanner.style.display = 'none';
                    settingsOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
            
            // Click sul bottone per aprire il banner
            settingsBtn.addEventListener('click', function() {
                openSettingsBanner();
            });
            
            // Click sull'overlay per chiudere
            settingsOverlay.addEventListener('click', function() {
                closeSettingsBanner();
            });
            
            // Click su "Accetta"
            if (acceptBtn) {
                acceptBtn.addEventListener('click', function() {
                    localStorage.setItem(CONSENT_KEY, 'granted');
                    updateConsentStatus();
                    
                    // Carica GA4 se non è già caricato
                    if (window.loadGA4 && typeof window.loadGA4 === 'function') {
                        window.loadGA4();
                    } else if (typeof loadGA4 === 'function') {
                        loadGA4();
                    }
                    
                    // Chiudi il banner dopo un breve delay
                    setTimeout(function() {
                        closeSettingsBanner();
                    }, 500);
                });
            }
            
            // Click su "Rifiuta"
            if (rejectBtn) {
                rejectBtn.addEventListener('click', function() {
                    // Salva il rifiuto - questo è condiviso tra tutte le pagine
                    localStorage.setItem(CONSENT_KEY, 'denied');
                    
                    // Trigger evento personalizzato per sincronizzare altre pagine/iframe
                    try {
                        window.dispatchEvent(new StorageEvent('storage', {
                            key: CONSENT_KEY,
                            newValue: 'denied',
                            oldValue: localStorage.getItem(CONSENT_KEY),
                            storageArea: localStorage
                        }));
                    } catch (e) {
                        console.log('StorageEvent non supportato, uso fallback');
                    }
                    
                    updateConsentStatus();
                    
                    // Mostra il banner principale se presente (per riproporlo al prossimo load)
                    if (cookieBanner) {
                        // Non mostrare subito, verrà mostrato al prossimo load
                        cookieBanner.style.display = 'none';
                    }
                    
                    // Ferma GA4 quando il consenso viene negato
                    if (window.stopGA4 && typeof window.stopGA4 === 'function') {
                        window.stopGA4();
                    } else if (typeof stopGA4 === 'function') {
                        stopGA4();
                    }
                    
                    // Chiudi il banner dopo un breve delay
                    setTimeout(function() {
                        closeSettingsBanner();
                    }, 500);
                });
            }
            
            // Click su "Chiudi"
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeSettingsBanner();
                });
            }
            
            // Aggiorna lo stato all'apertura
            updateConsentStatus();
            
            // Ascolta i cambiamenti di localStorage per aggiornare lo stato in tempo reale
            // Questo è importante quando il consenso viene modificato in altre pagine
            window.addEventListener('storage', function(e) {
                if (e.key === CONSENT_KEY) {
                    updateConsentStatus();
                }
            });
            
            // Per iframe same-origin, l'evento storage potrebbe non funzionare
            // Quindi controlliamo periodicamente se il consenso è cambiato
            let lastConsent = localStorage.getItem(CONSENT_KEY);
            const checkConsentInterval = setInterval(function() {
                const currentConsent = localStorage.getItem(CONSENT_KEY);
                if (currentConsent !== lastConsent) {
                    updateConsentStatus();
                    lastConsent = currentConsent;
                }
            }, 500);
            
            // Ferma il controllo dopo 30 secondi (dopo quel tempo, il consenso è stabile)
            setTimeout(function() {
                clearInterval(checkConsentInterval);
            }, 30000);
        })();
    </script>
</body>
</html>

